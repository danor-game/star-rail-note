import{_ as W,c as A,s as U,r as b,w as B,a as _,b as D,u,x as O,m as F,y as X,e as m,d as c,E as ae,I as ge,D as V,J as fe,f as $,C as y,F as Z,i as Q,h as I,j as H,q as he,K as pe,$ as q,t as ee,L as ye,M as be,p as ke,n as $e}from"./index-iDzqh3sp.js";import{M as R}from"./meta-eUFWZLzx.js";import{p as le,a as se,l as we,T as xe,s as j}from"./load-profiles-j6jIeUOi.js";const _e=n=>{const p=String(n).trim();return/^[1-9]\d*(\.\d+)?$/.test(p)?`${p}px`:p},Le=_e,Pe=["checked"],Se=["disabled"],Ce={class:"inblock"},Me=["placeholder","tabindex","readonly","disabled"],Ve={__name:"textbox",props:{modelValue:{type:[String,Number,Boolean],default:""},disable:{type:Boolean,default:!1},text:{type:String,default:""},default:{type:[String,Number,Boolean],default:""},disabling:{type:[Boolean,String],default:!1},readonly:{type:[Boolean,String],default:!1},...le,place:{type:[Number,String],default:""},tab:{type:[Number,String],default:0},align:{type:String,default:null},height:{type:[Number,String],default:void 0},focusSwitch:{type:Boolean,default:!1}},emits:["update:modelValue","update:disable","update:value"],setup(n,{emit:p}){const r=n,v=p,i=A(()=>U(r.disabling)),k=A(()=>U(r.readonly)),{$label:w,$labelWidth:L,$labelAlign:M}=se(r,i),C=A(()=>r.height==null?void 0:Le(r.height)),P=A(()=>({width:L.value,textAlign:M.value})),g=b(i.value&&r.modelValue===!1?r.default:r.modelValue),l=b(i.value?r.modelValue===!1:r.disable);B(()=>r.disable,h=>{i.value||(l.value=h)}),B(()=>r.modelValue,h=>{i.value?h===!1?l.value=!0:(l.value=!1,g.value=h):g.value=h}),B([g,l],([h,x],[o,s])=>{i.value?(h!=o&&v("update:value",h),x!=s&&v("update:disable",x),v("update:modelValue",x===!0?!1:h)):v("update:modelValue",h)});const f=b(null);return B(()=>r.focusSwitch,()=>f.value.focus()),(h,x)=>(_(),D("comp-texter",null,[i.value?(_(),D("p-disabling",{key:0,class:"inblock",checked:u(O)(!l.value),onClick:x[0]||(x[0]=o=>l.value=!l.value)},null,8,Pe)):F("",!0),u(w)?(_(),D("p-label",{key:1,disabled:u(O)(l.value),class:"inblock elli",style:X(P.value),onClick:x[1]||(x[1]=o=>i.value&&(l.value=!l.value))},m(u(w)),13,Se)):F("",!0),c("p-value",Ce,[ae(c("textarea",{ref_key:"domInput",ref:f,"onUpdate:modelValue":x[2]||(x[2]=o=>g.value=o),style:X({textAlign:n.align,height:C.value}),placeholder:n.place,tabindex:n.tab,readonly:k.value,disabled:u(O)(l.value)},null,12,Me),[[ge,g.value]])])]))}},te=W(Ve,[["__scopeId","data-v-528a0b10"]]),De=["checked"],Ee=["disabled"],Te={class:"inblock"},Fe=["disabled"],Ne={__name:"file-dragger",props:{modelValue:{type:[Array,Boolean],default:()=>[]},disable:{type:Boolean,default:!1},text:{type:String,default:""},default:{type:[String,Number,Boolean],default:""},disabling:{type:[Boolean,String],default:!1},readonly:{type:[Boolean,String],default:!1},...le,accept:{type:String,default:""},multiSelect:{type:[Boolean,String],default:!0},dragLabel:{type:String,default:"拖入 <文件> 到此"},draggingLabel:{type:String,default:"松开即可选入 <文件>"}},emits:["update:modelValue","update:disable","update:value"],setup(n,{emit:p}){const r=n,v=p,i=A(()=>U(r.disabling)),k=A(()=>U(r.readonly)),w=A(()=>U(r.multiSelect)),{$label:L,$labelWidth:M,$labelAlign:C}=se(r,i),P=A(()=>({width:M.value,textAlign:C.value})),g=b(i.value&&r.modelValue===!1?r.default:r.modelValue),l=b(i.value?r.modelValue===!1:r.disable);B(()=>r.disable,o=>{i.value||(l.value=o)}),B(()=>r.modelValue,o=>{i.value?o===!1?l.value=!0:(l.value=!1,g.value=o):g.value=o}),B([g,l],([o,s],[S,Y])=>{i.value?(o!=S&&v("update:value",o),s!=Y&&v("update:disable",s),v("update:modelValue",s===!0?!1:o)):v("update:modelValue",o)});const f=b(!1),h=b(null);B(h,()=>{const o=h.value;o&&(o.addEventListener("dragenter",()=>{l.value||k.value||(o.setAttribute("dragging",""),f.value=!0)}),o.addEventListener("dragleave",()=>{l.value||k.value||(o.removeAttribute("dragging"),f.value=!1)}),o.addEventListener("dragover",s=>{l.value||k.value||s.preventDefault()}),o.addEventListener("drop",async s=>{l.value||k.value||(s.preventDefault(),s.stopPropagation(),o.removeAttribute("dragging"),f.value=!1,g.value=[...s.dataTransfer?.files??[]])}),o.addEventListener("paste",async s=>{l.value||k.value||(s.preventDefault(),s.stopPropagation(),g.value=[...s.clipboardData?.files??[]])}))});const x=()=>{if(l.value||k.value)return;const o=document.createElement("input");o.type="file",o.multiple=w.value,o.accept=r.accept,o.addEventListener("input",()=>g.value=[...o.files??[]]),o.click()};return(o,s)=>(_(),D("comp-file-dragger",null,[i.value?(_(),D("p-disabling",{key:0,class:"inblock",checked:u(O)(!l.value),onClick:s[0]||(s[0]=S=>l.value=!l.value)},null,8,De)):F("",!0),u(L)?(_(),D("p-label",{key:1,disabled:u(O)(l.value),class:"inblock elli",style:X(P.value),onClick:s[1]||(s[1]=S=>i.value&&(l.value=!l.value))},m(u(L)),13,Ee)):F("",!0),c("p-value",Te,[c("p-drag",{ref_key:"domDrag",ref:h,disabled:u(O)(l.value),onClick:x},m(f.value?n.draggingLabel:n.dragLabel),9,Fe)])]))}},Ae=W(Ne,[["__scopeId","data-v-43bbb4e0"]]),Be=window.XMLHttpRequestGM,Ye=async(n,p="GET",r,v=!1)=>new Promise((i,k)=>Be(Object.assign({},r,{method:p,url:n,onload(w){i(v?w:w.responseText)},onerror(w){k(w?.error??w)}}))),ne=n=>{const p=n>0?"+":"-";n=Math.abs(n);const r=parseInt(n/1),v=parseInt((n-r*1)/Math.pow(60,-1));return`${p}${String(r).padStart(2,"0")}:${String(v).padStart(2,"0")}`},Ie=(n,p)=>({id:n.id,item:n.item_id,pool:n.gacha_id,type:n.gacha_type,time:V(`${n.time} ${ne(p)}`,"YYYY-MM-DD HH:mm:ss Z").unix()}),je=async(n,p=!1,r)=>{const v=new URL(R.api.urlGachaLog);v.searchParams.set("authkey_ver",n.versionKeyAuth),v.searchParams.set("authkey",decodeURIComponent(n.keyAuth)),v.searchParams.set("lang",n.lang??R.api.lang),v.searchParams.set("game_biz",n.bizGame??R.api.bizGame),v.searchParams.set("size",20);const i=p?[]:n.logsParsed,k=[];for(const L in R.typesPoolGacha$id){const{name:M}=R.typesPoolGacha$id[L];let C="0";for(let P=0;;P++){const g=new URL(v);g.searchParams.set("gacha_type",L),g.searchParams.set("end_id",C),await new Promise(s=>setTimeout(s,1e3*2));const l=JSON.parse(await Ye(g));if(l.retcode==-101)throw Error("链接已过期");if(l.retcode)throw Error(l.message);const f=l?.data?.list??[],h=l?.data?.region_time_zone;if(r.value=`正在获取${M}记录：第${P+1}页，发现${f?.length??0}条记录`,!f?.length)break;const x=C=f?.[f?.length-1]?.id;let o=!1;if(i.find(s=>s.id==x)&&(o=!0),k.push(...f),i.push(...f.filter(s=>{const S=i.find(Y=>Y.id==s.id);return S?S.item!=s.item_id||S.pool!=s.gacha_id||S.type!=s.gacha_type||S.time!=V(`${s.time} ${ne(h)}`,"YYYY-MM-DD HH:mm:ss Z").unix()?(globalThis.console.warn(`抽卡记录ID[${S.id}]相同，数据不相同`),!0):!1:!0}).map(s=>Ie(s,h))),o)break;await new Promise(s=>setTimeout(s,1e3))}}k.sort((L,M)=>V(M.time,"YYYY-MM-DD HH:mm:ss").unix()-V(L.time,"YYYY-MM-DD HH:mm:ss").unix()),i.sort((L,M)=>M.time-L.time),n.logsParsed=i;const w=V();return n.timeFetchFirst||(n.timeFetchFirst=w.format()),n.timeFetchLast=w.format(),{logsRaw:k,logsParsed:i}},N=n=>(ke("data-v-a779eca8"),n=n(),$e(),n),Oe=N(()=>c("p-version",null,"v1.1.0.1108",-1)),Ge={class:"block mb-4"},He=N(()=>c("span",{item:"",class:"float-right mt-4 ml-4 h-8"},"|",-1)),Re=N(()=>c("span",{item:"",class:"float-right mt-4 ml-4 h-8"},"|",-1)),Ue=N(()=>c("span",{item:"",class:"float-right mt-4 ml-4 h-8"},"|",-1)),ze=N(()=>c("div",{class:"clear-both"},null,-1)),Je=N(()=>c("p-split",{class:"block mt-4"},null,-1)),qe=N(()=>c("p-split",{class:"block mt-4"},null,-1)),Xe={class:"text-lg"},We=N(()=>c("div",{class:"text-xs mb-1"},"- 从官方接口获取到原始数据，仅以UID和获取时间分类，不以档案分类",-1)),Ke=N(()=>c("div",{class:"text-xs mb-4"},"- 理论上其他分析应用可以通过导入原始数据直接进行分析（如果它们提供导入的话）",-1)),Ze=["selected","onClick"],Qe={__name:"manager",setup(n){const p=window.XMLHttpRequestGM,r=typeof p=="function",v=async(a,t="GET",d,e=!1)=>new Promise((G,E)=>p(Object.assign({},d,{method:t,url:a,onload(J){G(e?J:J.responseText)},onerror(J){E(J)}}))),i=b(we()),k=b(null),w=b(""),L=b([]),M=a=>{w.value=a.uid,L.value=Object.keys(localStorage).filter(t=>t.startsWith(`logsRaw-${a.uid}`)).map(t=>({key:t,selected:!1})),k.value.showModal()},C=b(null),P=b(""),g=b(null),l=b({}),f=b(""),h=()=>{l.value={nick:"",urlLog:""},f.value="create",g.value.showModal()},x=a=>{l.value={nick:a.nick,urlLog:"",profile:a},f.value="modify",g.value.showModal()},o=async a=>{if(!await pe(`确定要删除档案【${a.name}】（${a.uid}）
这是不可恢复不可撤回的操作！`,"删除档案",{text:"删除档案！",value:!0},{text:"不了不了",value:!1,reverse:!0}))return;const t=i.value.indexOf(a);~t&&(i.value.splice(t,1),j(i.value))},s=async(a,t)=>{try{const d=new URL(a.urlLog),e={nick:a.nick,name:"",uid:null,keyAuth:d.searchParams.get("authkey"),versionKeyAuth:d.searchParams.get("authkey_ver"),logsParsed:[],timeFetchFirst:null,timeFetchLast:null};i.value.push(e),j(i.value),t&&await z(e,!0),g.value.close()}catch(d){q("创建档案",d)}},S=async(a,t)=>{try{const d=new URL(a.urlLog);a.profile.keyAuth=d.searchParams.get("authkey"),a.profile.versionKeyAuth=d.searchParams.get("authkey_ver"),j(i.value),t&&await z(a.profile,!1),g.value.close()}catch(d){q("创建档案",d)}},Y=b(null),T=b({json:"",files:[]}),oe=()=>{T.value.json="",Y.value.showModal()},ie=a=>{try{const t=JSON.parse(a);if(t&&typeof t=="object")i.value.push(t),j(i.value);else throw Error("导入的JSON数据类型不是Object")}catch(t){q("导入档案",t)}Y.value.close()},re=()=>{const a=T.value.files[0],t=new FileReader;t.addEventListener("load",d=>T.value.json=d.target.result),t.readAsText(a)},ue=a=>{const t=a?.clipboardData?.files?.[0];if(!t)return;const d=new FileReader;d.addEventListener("load",e=>T.value.json=e.target.result),d.readAsText(t)},K=async(a,t=!1)=>{P.value="正在获取基础信息...",t&&C.value.showModal();try{const{uid:d}=a,e=JSON.parse(await v(`https://api.mihomo.me/sr_info_parsed/${d}`));a.nick=a.nick||e?.player?.nickname,a.name=e?.player?.nickname,a.level=e?.player?.level,a.levelWorld=e?.player?.world_level,a.sizeCharacter=e?.player?.space_info?.avatar_count??0,a.countAchievement=e?.player?.space_info?.achievement_count??0,t&&(j(i.value),C.value.close())}catch(d){P.value=d?.message??d}},z=async(a,t=!1)=>{P.value="开始更新...",C.value.showModal();try{const{logsRaw:d}=await je(a,t,P);d[0]&&(a.uid=d[0].uid,K(a)),localStorage.setItem(`logsRaw-${a.uid}-${V().format("YYMMDDHHmmss")}`,JSON.stringify(d)),j(i.value),C.value.close()}catch(d){P.value=d?.message??d}},de=a=>{const t=document.createElement("a");t.download=`profile-${a.uid}-${a.nick!=a.name?`${a.name} (${a.nick})`:a.name}-${V().format("YYMMDD HHmmss")}.json`,t.href=URL.createObjectURL(new Blob([JSON.stringify(a)])),t.click()},ce=a=>ee.add("gacha-analysis",{type:"icon|title",title:"跃迁分析",icon:ye},a.uid),me=a=>ee.add("achievement-manager",{type:"icon|title",title:"成就管理",icon:be},a.uid),ve=()=>document.querySelector(":root").classList.toggle("color-scheme-dark");return(a,t)=>{const d=fe("tip");return _(),D("module",null,[c("p-fixed-topbar",null,[$(u(y),{item:"",class:"!w-32",text:"创建档案",onClick:h}),$(u(y),{item:"",class:"!w-32",text:"导入档案",onClick:oe}),$(u(y),{item:"",class:"!w-32",text:"切换主题",white:"",onClick:ve}),Oe]),c("p-main-box",null,[c("p-gm-xhr-result",Ge,"● GreaseMonkey XMLHttpRequest："+m(r?"✔ 存在":"✖ 不存在"),1),(_(!0),D(Z,null,Q(i.value,(e,G)=>(_(),D("p-profile",{key:`profile-${e.uid||G}`},[c("p-info",null,"档案"+m(G+1)+" <"+m(e.nick)+">",1),c("p-info",null,"    - "+m(e.name)+"（"+m(e.uid)+"）",1),c("p-info",null,"    - "+m(e.level)+"级，均衡"+m(e.levelWorld),1),c("p-info",null,"    - 共解锁"+m(e.sizeCharacter)+"位角色，"+m(e.countAchievement)+"个成就",1),c("p-info",null,"总抽卡次数："+m(e.logsParsed.length),1),c("p-info",null,"初次获取时间："+m(e.timeFetchFirst)+" ("+m(u(V)(e.timeFetchFirst).fromNow())+")",1),c("p-info",null,"最后获取时间："+m(e.timeFetchLast)+" ("+m(u(V)(e.timeFetchLast).fromNow())+")",1),c("p-info",null,"最后抽卡时间："+m(u(V)(e.logsParsed[0]?.time,"X").format())+" ("+m(u(V)(e.logsParsed[0]?.time,"X").fromNow())+")",1),$(u(y),{item:"",class:"float-right mt-4 ml-4 h-8",text:"跃迁分析",onClick:I(E=>ce(e),["exact"])},null,8,["onClick"]),$(u(y),{item:"",class:"float-right mt-4 ml-4 h-8",text:"成就管理",onClick:I(E=>me(e),["exact"])},null,8,["onClick"]),He,ae($(u(y),{item:"",class:"float-right mt-4 ml-4 h-8",text:"获取记录",onClick:[I(E=>z(e,!1),["exact"]),I(E=>z(e,!0),["alt"]),I(E=>K(e,!0),["ctrl"])]},null,8,["onClick"]),[[d,`默认-增量获取
alt-完整获取
ctrl-只获取基础信息`]]),Re,$(u(y),{item:"",class:"float-right mt-4 ml-4 h-8",text:"更新档案",onClick:I(E=>x(e),["exact"])},null,8,["onClick"]),$(u(y),{item:"",class:"float-right mt-4 ml-4 h-8",text:"导出档案",onClick:E=>de(e)},null,8,["onClick"]),Ue,e.uid?(_(),H(u(y),{key:0,item:"",class:"float-right mt-4 ml-4 h-8 lead-b2-8",text:"管理原始数据",white:"",onClick:E=>M(e)},null,8,["onClick"])):F("",!0),$(u(y),{item:"",class:"float-right mt-4 ml-4 h-8 lead-b2-8",text:"删除档案",white:"",onClick:E=>o(e)},null,8,["onClick"]),ze]))),128))]),c("dialog",{ref_key:"dialogEditorProfile",ref:g},[$(u(xe),{modelValue:l.value.nick,"onUpdate:modelValue":t[0]||(t[0]=e=>l.value.nick=e),item:"",class:"!block !w-[50vw]","label-width":"6rem",label:"档案名",place:"可留空，显示最新角色名称",readonly:a.brop(f.value=="modify")},null,8,["modelValue","readonly"]),$(u(te),{modelValue:l.value.urlLog,"onUpdate:modelValue":t[1]||(t[1]=e=>l.value.urlLog=e),item:"",class:"!block !w-[50vw] !h-24","label-width":"6rem",label:"日志URL"},null,8,["modelValue"]),Je,f.value=="create"?(_(),H(u(y),{key:0,item:"",_right:"",text:"创建并获取",onClick:t[2]||(t[2]=e=>s(l.value,!0))})):F("",!0),f.value=="create"?(_(),H(u(y),{key:1,item:"",_right:"",text:"仅创建",onClick:t[3]||(t[3]=e=>s(l.value,!1))})):F("",!0),f.value=="modify"?(_(),H(u(y),{key:2,item:"",_right:"",text:"更新并获取",onClick:t[4]||(t[4]=e=>S(l.value,!0))})):F("",!0),f.value=="modify"?(_(),H(u(y),{key:3,item:"",_right:"",text:"仅更新",onClick:t[5]||(t[5]=e=>S(l.value,!1))})):F("",!0)],512),c("dialog",{ref_key:"dialogEditorProfileImport",ref:Y,onPaste:ue},[$(u(te),{modelValue:T.value.json,"onUpdate:modelValue":t[6]||(t[6]=e=>T.value.json=e),item:"",class:"!block !w-[50vw] !h-24","label-width":"6rem",label:"档案JSON"},null,8,["modelValue"]),$(u(Ae),{modelValue:T.value.files,"onUpdate:modelValue":[t[7]||(t[7]=e=>T.value.files=e),re],item:"",class:"!block !w-[50vw] !h-24","label-width":"6rem",label:"档案文件",accept:".json","drag-label":"拖入 <档案JSON文件> 到此","dragging-label":"松开即读入 <档案JSON>"},null,8,["modelValue"]),qe,$(u(y),{item:"",class:"float-right mt-4",text:"导入创建",onClick:t[8]||(t[8]=e=>ie(T.value.json))})],544),c("dialog",{ref_key:"dialogLogsRaw",ref:k},[c("div",Xe,m(w.value)+"的原始记录",1),We,Ke,(_(!0),D(Z,null,Q(L.value,e=>(_(),D("p-raw-logs-option",{key:`key-logs-raw-${e}`,selected:a.brop(e.selected),onClick:G=>e.selected=!e.selected},[c("span",null,m(e.selected?"✔":"○"),1),he(" "+m(e.key),1)],8,Ze))),128)),$(u(y),{item:"",class:"float-right mt-4",text:"导出",onClick:t[9]||(t[9]=e=>s(l.value,!0))}),$(u(y),{item:"",class:"float-right mt-4",text:"合并去重",onClick:t[10]||(t[10]=e=>s(l.value,!0))}),$(u(y),{item:"",class:"float-right mt-4",text:"删除",white:"",onClick:t[11]||(t[11]=e=>s(l.value,!0))})],512),c("dialog",{ref_key:"dialogProgress",ref:C},m(P.value),513)])}}},lt=W(Qe,[["__scopeId","data-v-a779eca8"]]);export{lt as default};
